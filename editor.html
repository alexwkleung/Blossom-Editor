<!doctype html>

<title>Blossom Editor</title>
<meta charset="utf-8"/>

<!-- styles -->
<link rel=stylesheet href="lib/codemirror.css">
<link rel=stylesheet href="addon/dialog/dialog.css">

<!-- fonts -->
<!-- ibm plex sans - bold 700 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@700&display=swap" rel="stylesheet">

<!-- styles - themes -->
<link rel=stylesheet href="theme/3024-night.css">
<link rel=stylesheet href="theme/duotone-dark.css">
<link rel=stylesheet href="theme/paraiso-dark.css">
<link rel=stylesheet href="theme/material-darker.css">

<!-- codemirror script -->
<script src="lib/codemirror.js"></script>

<!-- mode scripts -->
<script src="mode/javascript/javascript.js"></script>
<script src="mode/css/css.js"></script>
<script src="mode/xml/xml.js"></script>
<script src="mode/htmlmixed/htmlmixed.js"></script>
<script src="mode/clike/clike.js"></script>
<script src="mode/markdown/markdown.js"></script>
<script src="mode/stex/stex.js"></script>

<!-- addon scripts -->
<script src="addon/search/search.js"></script>
<script src="addon/search/searchcursor.js"></script>
<script src="addon/search/jump-to-line.js"></script>
<script src="addon/dialog/dialog.js"></script>
<script src="addon/display/autorefresh.js"></script>

<!-- internal styles -->
<style>
  /*
  .CodeMirror { height: 100%; border: 1px hidden #ddd; background-color: black; }

  .CodeMirror-scroll { max-height: 100%; }

  .CodeMirror pre { padding-left: 7px; line-height: 1.25; }
  */

  body { background-color: #B39DDB; }
  
  .button-center { display: flex; justify-content: center; }
  
  .border { height: 53px; border-style: hidden; -webkit-user-select: none; user-select: none; -webkit-app-region: drag; }
  
  select { height: 48px; width: 125px; }
  
  .mode { height: 48px; width: 135px; }

  select { font-family: 'IBM Plex Sans', 'sans-serif'; }

  option { font-family: 'IBM Plex Sans', 'sans-serif'; }
</style>

<!-- button navigations -->
<div class="border">
<div class="button-center">
<button title="save" type="button" onclick="save()"><img src="img/save.png"></button> 
<button title="open new window" type="button" onclick="window.open('editor.html', '', 'width=1080, height=650, y=500, x=800, frame=false, resizable=false, fullscreenable=false, nodeIntegration=true')"><img src="img/new-window.png"></button>
<button title="change theme" type="button">
  <select onchange="selectTheme()" id=select>
    <!-- theme options -->
    <option selected>3024-night</option>
    <option>duotone-dark</option>
    <option>paraiso-dark</option>
    <option>material-darker</option>
  </select>
</button>

<button title="change mode" type="button">
  <select class="mode" onchange="selectMode()" id=mode>
    <!-- mode options -->
    <option selected>text/plain</option>
    <option>clike</option>
    <option>text/javascript</option>
    <option>text/html</option>
    <option>text/x-markdown</option>
    <option>text/x-stex</option>
  </select>
</button>

<button title="refresh/clear editor" type="button" onclick="window.location.reload()"><img src="img/clear.png"></button>
<button title="close window" type="button" onclick="window.close()"><img src="img/close.png"></button>
</div>

<!-- CodeMirror editor area -->
<textarea id="editor"></textarea>

<!-- editor script -->
<script>
  const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
    lineNumbers: true,
    mode: "text/plain",
    theme: '3024-night',
    smartIndent: false,
    autoRefresh: true,
    scrollbarStyle: null,
    //lineWrapping: true,
  });
  editor.setSize("100%", "650")
  //const textToWrite = editor.doc.getValue();

  //theme switching - credit: https://github.com/codemirror/CodeMirror/blob/master/demo/theme.html
  const input = document.getElementById("select");
  function selectTheme() {
    const theme = input.options[input.selectedIndex].textContent;
    editor.setOption("theme", theme);
    location.hash = "#" + theme;
  }

  const choice = (location.hash && location.hash.slice(1)) || (document.location.search && decodeURIComponent(document.location.search.slice(1)));
  
  if(choice) {
    input.value = choice;
    editor.setOption("theme", choice);
  }

  CodeMirror.on(window, "hashchange", function() {
    const theme = location.hash.slice(1);
    if(theme) { 
      input.value = theme; 
      selectTheme(); 
    }
  });

  //mode switching
  const modeInput = document.getElementById("mode");
  function selectMode() {
    const mode = modeInput.options[modeInput.selectedIndex].textContent;
    editor.setOption("mode", mode);
  }
</script>

<!-- save to file -->
<script>
  //credit: https://stackoverflow.com/questions/51315044/how-do-i-save-the-content-of-the-editor-not-the-whole-html-page

  function save() {
    const textToWrite = editor.getValue();
    const textFileAsBlob = new Blob([textToWrite], {
    type: "text/plain; charset=utf-8"
  });

  const fileNameToSaveAs = "blossom.txt";
  const downloadLink = document.createElement("a");

  downloadLink.download = fileNameToSaveAs;
  downloadLink.innerHTML = "Download File";

  if(window.webkitURL !== null) {
    //"Chrome allows the link to be clicked without adding it to the DOM."
    downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
    }
    downloadLink.click();
  }
</script>
